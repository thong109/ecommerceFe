<template>
  <Loading :isLoading="isLoading" />
  <Breadcrumb :titles="['C·ªßa h√†ng']" />
  <section class="shop spad">
    <div class="container">
      <div class="row">
        <div class="col-lg-3">
          <div class="shop__sidebar">
            <div class="shop__sidebar__search">
              <form action="#">
                <input type="text" placeholder="Search...">
                <button type="submit"><span class="">
                    <i class="bi bi-search"></i>
                  </span></button>
              </form>
            </div>
            <div class="shop__sidebar__accordion">
              <div class="accordion" id="accordionExample">
                <div class="card">
                  <div class="card-heading">
                    <a data-toggle="collapse" data-target="#collapseOne">Danh m·ª•c</a>
                  </div>
                  <div id="collapseOne" class="collapse show" data-parent="#accordionExample">
                    <div class="card-body">
                      <div class="shop__sidebar__categories">
                        <ul class="nice-scroll p-0">
                          <li v-for="(category, index) in categoryStore.data" :key="index">
                            <button type="button" class="border-0 bg-transparent"
                              @click="getProductByData(category.id, 'category')">
                              {{ category.name }}
                              <span class="ml-2">({{ category.products ? category.products.length : 0 }})</span>
                            </button>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-heading">
                    <a data-toggle="collapse" data-target="#collapseTwo">Th∆∞∆°ng hi·ªáu</a>
                  </div>
                  <div id="collapseTwo" class="collapse show" data-parent="#accordionExample">
                    <div class="card-body">
                      <div class="shop__sidebar__brand">
                        <ul class="nice-scroll p-0">
                          <li v-for="(brand, index) in brandStore.data" :key="index">
                            <button type="button" class="border-0 bg-transparent"
                              @click="getProductByData(brand.id, 'brand')">
                              {{ brand.name }}
                              <span class="ml-2">({{ brand.products ? brand.products.length : 0 }})</span>
                            </button>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-heading">
                    <a data-toggle="collapse" data-target="#collapseSix">Tags</a>
                  </div>
                  <div id="collapseSix" class="collapse show" data-parent="#accordionExample">
                    <div class="card-body">
                      <div class="shop__sidebar__tags">
                        <a href="#">Product</a>
                        <a href="#">Bags</a>
                        <a href="#">Shoes</a>
                        <a href="#">Fashio</a>
                        <a href="#">Clothing</a>
                        <a href="#">Hats</a>
                        <a href="#">Accessories</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-9">
          <div class="shop__product__option">
            <div class="row">
              <div class="col-lg-6 col-md-6 col-sm-6">
                <div class="shop__product__option__left">
                  <p>Hi·ªÉn th·ªã {{ visibleProducts.length }} trong s·ªë {{ totalProductCount }} k·∫øt qu·∫£</p>
                </div>
              </div>
              <div class="col-lg-6 col-md-6 col-sm-6">
                <div class="shop__product__option__right d-flex align-items-center">
                  <p style="flex: 0 0 auto;" class="mr-2">S·∫Øp x·∫øp theo:</p>
                  <select class="form-select" @change="handleSort">
                    <option value="low">T·ª´ th·∫•p ƒë·∫øn cao</option>
                    <option value="high">T·ª´ cao ƒë·∫øn th·∫•p</option>
                    <option value="rating">ƒê√°nh gi√°</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div v-for="(product, index) in visibleProducts" :key="index" class="col-lg-4 col-md-6 col-sm-6 pb-4">
              <div
                class="product__item d-flex flex-column justify-content-between border rounded-3 shadow-sm p-3 h-100">
                <div class="product__item__pic d-block position-relative">
                  <img :src="getAvatarUrl(product.image)"
                    class="w-100 h-100 object-fit-cover position-absolute top-0 start-0 end-0 bottom-0 "
                    :alt="product.name" loading="eager">
                  <!-- <span v-if="product.discounted > 0" class="label text-white">{{ product.discounted }}%</span> -->
                  <ul class="product__hover">
                    <li><a href="#" class="bg-opacity-8 bg-dark-subtle border rounded-2"><i
                          class="bi bi-heart text-white"></i></a></li>
                    <li><a href="#" class="bg-opacity-8 bg-dark-subtle border rounded-2"><i
                          class="bi bi-search text-white"></i></a></li>
                  </ul>
                </div>
                <div class="product__item__text">
                  <div class="d-block">
                    <h6>
                      <router-link :to="`/product/${product.id}`">{{ product.name }}</router-link>
                    </h6>
                    <div class="rating">
                      <i v-for="i in 5" :key="i"
                        :class="i <= product.rating ? 'bi bi-star-fill text-warning' : 'bi bi-star'"></i>
                    </div>
                  </div>
                  <h5>{{ formatPrice(product.price) }}</h5>
                </div>
              </div>
            </div>
          </div>
          <div class="text-center mt-4" v-if="visibleProducts.length < totalProductCount">
            <button class="primary-btn bg-transparent text-dark border-black" @click="loadMore" :disabled="isLoading">
              <span v-if="isLoading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                ƒêang t·∫£i...
              </span>
              <span v-else>
                Xem th√™m
              </span>
            </button>
          </div>

          <div class="text-center mt-4" v-else>
            <p>Kh√¥ng c√≤n s·∫£n ph·∫©m n√†o ƒë·ªÉ hi·ªÉn th·ªã</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import Breadcrumb from '@/components/home/Breadcrumb.vue';
import { computed, onMounted, ref } from 'vue';
import axiosConfig from '@/helpers/axiosConfig'
import { useCategoryStore } from '@/stores/category';
import { useBrandStore } from '@/stores/brand';
import { formatPrice, getAvatarUrl } from '@/helpers/formatted';
import Loading from '@/components/Loading.vue';

const categoryStore = useCategoryStore()
const brandStore = useBrandStore()
const visibleProducts = ref([]);
const totalProductCount = ref(0);
const isLoading = ref(true);
const productsPerLoad = ref(6);
const currentPage = ref(1);
const sortOption = ref('low');
const getBy = ref({
  name: 'product',
  id: null
})

// ‚úÖ S·ªë s·∫£n ph·∫©m hi·ªán ƒëang hi·ªÉn th·ªã
const currentLoadedCount = computed(() => visibleProducts.value.length);

// üü¶ H√†m load th√™m s·∫£n ph·∫©m (Xem th√™m)
const loadMore = async () => {
  isLoading.value = true;

  try {
    const response = await axiosConfig.get(
      `/products?page=${currentPage.value}&limit=${productsPerLoad.value}&sort=${sortOption.value}&getBy=${getBy.value.name}&id=${getBy.value.id}`
    );

    const data = response.data;

    visibleProducts.value.push(...data.products);
    totalProductCount.value = data.total;
    currentPage.value += 1;
  } catch (error) {
    console.error("C√≥ l·ªói khi t·∫£i s·∫£n ph·∫©m:", error);
  } finally {
    isLoading.value = false;
  }
};

// üü® H√†m load l·∫°i ƒë√∫ng s·ªë l∆∞·ª£ng ƒë√£ hi·ªÉn th·ªã nh∆∞ng theo sort m·ªõi
const loadUntilCount = async (targetCount) => {
  isLoading.value = true;
  visibleProducts.value = [];
  currentPage.value = 1;

  try {
    while (visibleProducts.value.length < targetCount) {
      const response = await axiosConfig.get(
        `/products?page=${currentPage.value}&limit=${productsPerLoad.value}&sort=${sortOption.value}&getBy=${getBy.value.name}&id=${getBy.value.id}`
      );

      const data = response.data;

      visibleProducts.value.push(...data.products);
      totalProductCount.value = data.total;
      currentPage.value += 1;

      if (visibleProducts.value.length >= data.total) break;
    }
  } catch (error) {
    console.error("L·ªói khi load s·∫£n ph·∫©m khi sort:", error);
  } finally {
    isLoading.value = false;
  }
};

// üüß Khi ch·ªçn sort
const handleSort = async (e) => {
  sortOption.value = e.target.value;
  currentPage.value = 1;
  totalProductCount.value = 0;

  await loadUntilCount(currentLoadedCount.value); // Load l·∫°i ƒë√∫ng s·ªë ƒë√£ hi·ªán
};

// üü© Khi ch·ªçn theo danh m·ª•c
const getProductByData = async (id, type) => {
  getBy.value = {
    name: type,
    id: id
  };

  visibleProducts.value = [];
  totalProductCount.value = 0;
  currentPage.value = 1;

  await loadMore(); // Load l·∫°i t·ª´ ƒë·∫ßu danh m·ª•c
};

// üü¶ L√∫c ƒë·∫ßu load danh m·ª•c v√† s·∫£n ph·∫©m
onMounted(async () => {
  await categoryStore.fetchProductByCategory();
  await brandStore.fetchProductByBrand();
  await loadMore();
});

</script>
